name: Deploy Supabase Edge Functions

on:
  push:
    branches:
      - main
    paths:
      - 'supabase/functions/**'
  workflow_dispatch:

env:
  SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

jobs:
  deploy-critical-functions:
    name: Deploy Critical Edge Functions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase project
        run: |
          supabase link --project-ref $SUPABASE_PROJECT_REF

      - name: Deploy critical functions
        run: |
          echo "üöÄ Iniciando deploy das Edge Functions cr√≠ticas..."
          
          CRITICAL_FUNCTIONS=(
            "api-bling"
            "mp-checkout-init"
            "calculate-shipping"
            "mp-create-order-and-pay"
            "mercadopago-webhook"
            "create-mercadopago-payment"
            "aprovar-faturamento"
            "bling-generate-nfe"
            "shopify-storefront-products"
            "ebd-shopify-order-webhook"
          )
          
          FAILED=()
          SUCCESS=()
          
          for fn in "${CRITICAL_FUNCTIONS[@]}"; do
            echo ""
            echo "üì¶ Deployando: $fn"
            echo "----------------------------------------"
            
            if supabase functions deploy "$fn" --project-ref $SUPABASE_PROJECT_REF; then
              echo "‚úÖ $fn - Deploy OK"
              SUCCESS+=("$fn")
            else
              echo "‚ùå $fn - Deploy FALHOU"
              FAILED+=("$fn")
            fi
          done
          
          echo ""
          echo "========================================="
          echo "üìä RESUMO DO DEPLOY"
          echo "========================================="
          echo "‚úÖ Sucesso: ${#SUCCESS[@]} fun√ß√µes"
          for fn in "${SUCCESS[@]}"; do echo "   - $fn"; done
          echo ""
          
          if [ ${#FAILED[@]} -gt 0 ]; then
            echo "‚ùå FALHAS: ${#FAILED[@]} fun√ß√µes"
            for fn in "${FAILED[@]}"; do echo "   - $fn"; done
            echo ""
            echo "üî¥ WORKFLOW FALHOU - Corrija os erros acima"
            exit 1
          fi
          
          echo "üéâ Todas as fun√ß√µes cr√≠ticas deployadas com sucesso!"

  healthcheck:
    name: Healthcheck Edge Functions
    runs-on: ubuntu-latest
    needs: deploy-critical-functions
    
    steps:
      - name: Wait for propagation
        run: sleep 10

      - name: Healthcheck - OPTIONS requests
        run: |
          echo "üîç Verificando disponibilidade via OPTIONS..."
          
          BASE_URL="https://${{ secrets.SUPABASE_PROJECT_REF }}.supabase.co/functions/v1"
          
          CRITICAL_FUNCTIONS=(
            "api-bling"
            "mp-checkout-init"
            "calculate-shipping"
            "mp-create-order-and-pay"
            "mercadopago-webhook"
            "create-mercadopago-payment"
            "aprovar-faturamento"
            "bling-generate-nfe"
            "shopify-storefront-products"
            "ebd-shopify-order-webhook"
          )
          
          ALL_OK=true
          
          for fn in "${CRITICAL_FUNCTIONS[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -X OPTIONS \
              -H "Origin: https://gestaoebd.com.br" \
              -H "Access-Control-Request-Method: POST" \
              "$BASE_URL/$fn")
            
            if [ "$STATUS" == "200" ]; then
              echo "‚úÖ $fn: OPTIONS ‚Üí $STATUS"
            elif [ "$STATUS" == "404" ]; then
              echo "‚ùå $fn: OPTIONS ‚Üí 404 NOT_FOUND - FUN√á√ÉO N√ÉO DEPLOYADA!"
              ALL_OK=false
            else
              echo "‚ö†Ô∏è $fn: OPTIONS ‚Üí $STATUS (esperado 200)"
            fi
          done
          
          if [ "$ALL_OK" = false ]; then
            echo ""
            echo "üî¥ HEALTHCHECK FALHOU - Algumas fun√ß√µes retornaram 404!"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Todas as fun√ß√µes responderam ao OPTIONS"

      - name: Healthcheck - POST requests (verify not 404)
        run: |
          echo "üîç Verificando POST (aceita 200/400/401, rejeita 404)..."
          
          BASE_URL="https://${{ secrets.SUPABASE_PROJECT_REF }}.supabase.co/functions/v1"
          
          CRITICAL_FUNCTIONS=(
            "api-bling"
            "mp-checkout-init"
            "calculate-shipping"
            "mp-create-order-and-pay"
            "mercadopago-webhook"
            "create-mercadopago-payment"
            "aprovar-faturamento"
            "bling-generate-nfe"
            "shopify-storefront-products"
            "ebd-shopify-order-webhook"
          )
          
          ALL_OK=true
          
          for fn in "${CRITICAL_FUNCTIONS[@]}"; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -X POST \
              -H "Content-Type: application/json" \
              -H "Origin: https://gestaoebd.com.br" \
              -d '{}' \
              "$BASE_URL/$fn")
            
            if [ "$STATUS" == "404" ]; then
              echo "‚ùå $fn: POST ‚Üí 404 NOT_FOUND - FUN√á√ÉO N√ÉO EXISTE!"
              ALL_OK=false
            elif [ "$STATUS" == "200" ] || [ "$STATUS" == "400" ] || [ "$STATUS" == "401" ] || [ "$STATUS" == "403" ]; then
              echo "‚úÖ $fn: POST ‚Üí $STATUS (fun√ß√£o ativa)"
            else
              echo "‚ö†Ô∏è $fn: POST ‚Üí $STATUS (inesperado, mas n√£o √© 404)"
            fi
          done
          
          if [ "$ALL_OK" = false ]; then
            echo ""
            echo "üî¥ HEALTHCHECK FALHOU - Algumas fun√ß√µes retornaram 404!"
            exit 1
          fi
          
          echo ""
          echo "üéâ Healthcheck completo - Todas as fun√ß√µes est√£o ativas!"
